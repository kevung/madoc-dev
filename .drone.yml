---
kind: pipeline
type: docker
name: assets
steps:

- name: get_assets
  image: alpine/git
  commands:
  - git clone http://192.168.0.21:3000/kevin/madoc-assets.git assets
  - 'ls -ltr'
  - 'ls -ltr assets'

---
kind: pipeline
type: docker
name: test
steps:

- name: get_commit
  image: alpine/git
  commands:
  - git rev-parse --short HEAD > commit.txt
  - 'cat commit.txt'

- name: aspell
  image: facteurpat/aspell:latest
  commands:
  - cat ./assets/aspell/lang.txt
  - bash ./assets/aspell/check.sh

- name: reqflow
  image: alpine
  commands:
  - echo Suivi des exigences avec Reqflow
  - echo "A mettre en place!" > ./reqflow.txt

- name: pack
  image: alpine
  commands:
  - COMMIT=$(cat ./commit.txt)
  - NAME=$(cat ./NAME.md)
  - mkdir -p ./test
  - cp aspell.txt ./test/aspell-$COMMIT.txt
  - cp reqflow.txt ./test/reqflow-$COMMIT.txt
  - ls -ltr ./test

- name: release
  image: plugins/gitea-release
  settings:
    base_url: http://192.168.0.21:3000
    api_key: 7073fe81a3cc1c60bc01d01ceb24d6bb87f8ea43
    files: /drone/src/test/*
    insecure: true
  when:
    event: tag

depends_on:
- assets

---
kind: pipeline
type: docker
name: build
steps:

- name: get_commit
  image: alpine/git
  commands:
  - git rev-parse --short HEAD > commit.txt
  - 'cat commit.txt'

- name: pandoc
  image: pandoc/latex:latest
  commands:
  - COMMIT=$(cat ./commit.txt)
  - NAME=$(cat ./NAME.md)
  - BUILDNAME=$NAME-$COMMIT
  - cd ./assets/pandoc
  - 'sh ./build.sh pdf $BUILDNAME'
  - 'sh ./build.sh docx $BUILDNAME'
  - cd ../../
  - ls -ltr ./assets/pandoc

- name: mkdocs
  image: squidfunk/mkdocs-material:latest
  commands:
  - /usr/local/bin/mkdocs build
  - ls -ltr .

- name: pack
  image: alpine
  commands:
  - COMMIT=$(cat ./commit.txt)
  - NAME=$(cat ./NAME.md)
  - BUILDNAME=$NAME-$COMMIT
  - mkdir -p ./build
  - cp ./assets/pandoc/$BUILDNAME.pdf ./build
  - cp ./assets/pandoc/$BUILDNAME.docx ./build
  - tar zcvf $BUILDNAME-mkdocs.tgz site/
  - cp -r $BUILDNAME-mkdocs.tgz ./build
  - ls -ltr ./build

- name: release
  image: plugins/gitea-release
  settings:
    base_url: http://192.168.0.21:3000
    api_key: 7073fe81a3cc1c60bc01d01ceb24d6bb87f8ea43
    files: /drone/src/build/*
    insecure: true
  when:
    event: tag

depends_on:
- assets

---
kind: pipeline
type: docker
name: update-web
steps:

- name: deploy-scp-web
  image: appleboy/drone-scp
  failure: ignore
  settings:
    host: 192.168.0.21
    user: nginx
    password: nginx
    port: 22
    target: /www/data/site
    source: ./site/*

depends_on:
- build
